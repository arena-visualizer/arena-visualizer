<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Are.na Dynamic Collage Generator</title>
    <style>
        :root {
            --bg-color: #ffffff; --text-color: #000000; --border-color: #000000;
            --focus-color: #888888; --overlay-bg: rgba(255, 255, 255, 0.95);
        }
        body.cream-mode {
            --bg-color: #fdfaf3; --text-color: #4a4137; --border-color: #4a4137;
            --focus-color: #7d7061; --overlay-bg: rgba(253, 250, 243, 0.95);
        }
        body.dark-mode {
            --bg-color: #1a1a1a; --text-color: #e0e0e0; --border-color: #e0e0e0;
            --focus-color: #555555; --overlay-bg: rgba(26, 26, 26, 0.95);
        }
        * { box-sizing: border-box; }
        body { margin: 0; background-color: var(--bg-color); color: var(--text-color); font-family: 'Courier New', Courier, monospace; overflow: hidden; transition: background-color 0.3s, color 0.3s; }
        
        /* --- UI & Forms --- */
        .ui-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--overlay-bg); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; transition: background-color 0.3s; cursor: default; }
        #settings-overlay { display: none; }
        .ui-box { background-color: var(--bg-color); padding: 2rem 3rem; border: 1px solid var(--border-color); width: 500px; max-width: 90vw; transition: background-color 0.3s, border-color 0.3s; }
        .ui-box h2 { text-align: left; margin-top: 0; }
        .form-group { margin-bottom: 1rem; text-align: left; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; text-transform: uppercase; }
        .form-group input, .form-group select { width: 100%; padding: 0.5rem; background: none; border: 1px solid var(--border-color); color: var(--text-color); font-family: inherit; font-size: 1rem; }
        .form-group input:focus, .form-group select:focus, .action-button:focus { outline: 1px solid var(--focus-color); }
        .action-button { cursor: pointer; background-color: var(--text-color); color: var(--bg-color); border: 1px solid var(--border-color); padding: 0.75rem 2rem; font-family: inherit; font-size: 1rem; text-transform: uppercase; transition: background-color 0.2s, color 0.2s; }
        .action-button:hover { background-color: var(--bg-color); color: var(--text-color); }
        #status-message { margin-top: 1rem; font-size: 0.9rem; min-height: 1.2em; text-align: center; }
        #drop-zone { cursor: pointer; border: 2px dashed var(--border-color); margin-top: 1.5rem; padding: 2rem; text-align: center; opacity: 0.7; transition: opacity 0.2s, background-color 0.2s; }
        #drop-zone.drag-over { opacity: 1; background-color: var(--focus-color); }
        .separator { text-align: center; margin: 1.5rem 0; }
        #go-back-button { cursor: pointer; font-size: 0.8rem; text-align: left; margin-top: 1.5rem; opacity: 0.7; }

        /* --- Collage & Animations --- */
        #image-container { cursor: crosshair; }
        .image-wrapper { position: absolute; }
        .dynamic-image { display: block; width: 100%; height: auto; object-fit: cover; border: 1px solid var(--border-color); }
        .dynamic-image.no-border { border: none; }
        .info-box { display: none; background-color: var(--bg-color); border: 1px solid var(--border-color); border-top: none; padding: 8px; font-size: 10px; line-height: 1.5; width: 100%; }
        .info-box.latest-info, .info-box.show-all { display: block; }
        .info-box div { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } /* Prevents text overflow */
        
        .anim-fade { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .anim-pixelate { animation: pixelateIn 0.3s steps(4) forwards; }
        @keyframes pixelateIn { from { clip-path: inset(50%); } to { clip-path: inset(0); } }
    </style>
</head>
<body>

    <div id="image-container"></div>

    <div id="initial-screen" class="ui-screen">
        <div class="ui-box">
            <h2>// LOAD SOURCE</h2>
            <form id="load-form"><div class="form-group"><label for="channel-url">ARE.NA CHANNEL URL</label><input type="text" id="channel-url" placeholder="https://www.are.na/user/slug" required></div><button type="submit" class="action-button">LOAD_</button></form>
            <div class="separator"><span>OR</span></div>
            <div id="drop-zone">DRAG & DROP IMAGES HERE</div>
            <p id="status-message"></p>
        </div>
    </div>

    <div id="settings-overlay" class="ui-screen">
        <div class="ui-box">
            <h2>// CONFIGURE</h2>
            <form id="settings-form">
                <div class="form-group"><label for="order-mode">ORDER</label><select id="order-mode"><option value="sequential" selected>Sequential</option><option value="random">Random</option></select></div>
                <div style="display: flex; gap: 1rem;"><div class="form-group" style="flex:1;"><label for="bpm">SPEED (BPM)</label><input type="number" id="bpm" value="100" min="1" required></div><div class="form-group" style="flex:1;"><label for="max-images">MAX IMAGES</label><input type="number" id="max-images" value="16" min="1" required></div></div>
                <div style="display: flex; gap: 1rem;"><div class="form-group" style="flex:1;"><label for="min-size">MIN SIZE (PX)</label><input type="number" id="min-size" value="200" min="10" required></div><div class="form-group" style="flex:1;"><label for="max-size">MAX SIZE (PX)</label><input type="number" id="max-size" value="400" min="10" required></div></div>
                <div class="form-group"><label for="animation-mode">ANIMATION</label><select id="animation-mode"><option value="none" selected>None</option><option value="fade">Fade</option><option value="pixelate">Pixelate</option></select></div>
                <div class="form-group"><label for="info-box-mode">INFO BOX</label><select id="info-box-mode"><option value="latest" selected>Latest Only</option><option value="all">Show All</option><option value="none">Disabled</option></select></div>
                <div class="form-group"><label for="border-mode">BORDERS</label><select id="border-mode"><option value="enabled" selected>Enabled</option><option value="disabled">Disabled</option></select></div>
                <div class="form-group"><label for="theme-selector">THEME</label><select id="theme-selector"><option value="light" selected>Light</option><option value="cream">Cream</option><option value="dark">Dark</option></select></div>
                <button type="submit" class="action-button">INITIATE_</button>
                <div id="go-back-button">‚Üê Go Back <span id="back-hint">(ESC)</span></div>
            </form>
        </div>
    </div>

    <script>
        // --- DOM Elements & Global State ---
        const D = document;
        const initialScreen = D.getElementById('initial-screen'), settingsOverlay = D.getElementById('settings-overlay'),
            imageContainer = D.getElementById('image-container'), statusMessage = D.getElementById('status-message'),
            dropZone = D.getElementById('drop-zone'), backHint = D.getElementById('back-hint');
        let imageDataArray = [], currentIndex = 0, lastInfoBox = null, lastImageRect = null,
            collageInterval = null, currentScreen = 'initial', isPaused = false, settingsCache = {};
        const activeWrappers = [];

        // --- UI & Setup ---
        const isMobile = /Mobi|Android/i.test(navigator.userAgent);
        function detectMobileAndSetDefaults() { if (isMobile) { D.getElementById('min-size').value=60; D.getElementById('max-size').value=200; backHint.textContent = '(Shake)'; } }
        function applyTheme(theme) { D.body.className = theme === 'light' ? '' : `${theme}-mode`; }
        detectMobileAndSetDefaults(); applyTheme(D.getElementById('theme-selector').value);
        D.getElementById('theme-selector').addEventListener('input', (e) => applyTheme(e.target.value));

        // --- Navigation & Controls ---
        function goBack() {
            if (currentScreen === 'collage') {
                clearInterval(collageInterval); collageInterval = null; isPaused = false;
                imageContainer.innerHTML = ''; activeWrappers.length = 0; lastImageRect = null;
                settingsOverlay.style.display = 'flex'; currentScreen = 'settings';
            } else if (currentScreen === 'settings') {
                settingsOverlay.style.display = 'none'; initialScreen.style.display = 'flex';
                statusMessage.textContent = ''; imageDataArray = []; currentScreen = 'initial';
            }
        }
        function togglePause() {
            if (currentScreen !== 'collage') return;
            isPaused = !isPaused;
            if (isPaused) { clearInterval(collageInterval); collageInterval = null; } 
            else { startCollage((60/settingsCache.bpm)*1000, settingsCache, false); }
        }
        window.addEventListener('keydown', (e) => {
            if (['q', 'b', 'Escape'].includes(e.key)) goBack();
            if (['p', ' '].includes(e.key)) { e.preventDefault(); togglePause(); }
        });
        imageContainer.addEventListener('click', togglePause);
        D.getElementById('go-back-button').addEventListener('click', goBack);

        // --- Data Loading ---
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); processLocalFiles([...e.dataTransfer.files]); });
        function processLocalFiles(files) {
            const imageFiles = files.filter(f => f.type.startsWith('image/'));
            if (imageFiles.length === 0) { statusMessage.textContent = "No valid image files dropped."; return; }
            statusMessage.textContent = `Loading ${imageFiles.length} local images...`;
            Promise.all(imageFiles.map(file => new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = e => resolve({
                    url: e.target.result, user: file.name, id: 'N/A', contentType: file.type,
                    fileSize: `${(file.size / 1024).toFixed(1)} KB`, createdAt: new Date(file.lastModified).toISOString()
                });
                reader.readAsDataURL(file);
            }))).then(results => { imageDataArray = results; transitionToSettings(); });
        }
        D.getElementById('load-form').addEventListener('submit', async (e) => {
            e.preventDefault(); const urlInput = D.getElementById('channel-url').value.trim();
            statusMessage.textContent = 'Parsing...'; const slug = urlInput.split('/').pop();
            if (!slug) { statusMessage.textContent = 'Error: Invalid URL.'; return; }
            statusMessage.textContent = `Fetching ${slug}...`;
            try {
                const response = await fetch(`https://api.are.na/v2/channels/${slug}/contents?page=1&per=1000`);
                if (!response.ok) throw new Error(`API Error ${response.status}`);
                processApiData(await response.json());
                if (imageDataArray.length === 0) { statusMessage.textContent = 'No images found.'; return; }
                transitionToSettings();
            } catch (error) { statusMessage.textContent = `Error: ${error.message}`; }
        });
        function processApiData(data) {
            imageDataArray = data?.contents?.filter(item => item.class === 'Image' && item.image?.original?.url).map(item => ({
                url: item.image.original.url, id: item.id || 'N/A', contentType: item.image.content_type || 'N/A',
                fileSize: item.image.original.file_size_display || 'N/A', user: item.user?.username || 'anonymous',
                createdAt: item.created_at || 'N/A'
            })) || [];
        }
        function transitionToSettings() { initialScreen.style.display = 'none'; settingsOverlay.style.display = 'flex'; currentScreen = 'settings'; }

        // --- Settings & Collage Logic ---
        D.getElementById('settings-form').addEventListener('submit', (e) => {
            e.preventDefault();
            settingsCache = {
                bpm: parseInt(D.getElementById('bpm').value,10), minSize: parseInt(D.getElementById('min-size').value,10),
                maxSize: parseInt(D.getElementById('max-size').value,10), maxImages: parseInt(D.getElementById('max-images').value,10),
                animationMode: D.getElementById('animation-mode').value, infoBoxMode: D.getElementById('info-box-mode').value,
                borderMode: D.getElementById('border-mode').value, orderMode: D.getElementById('order-mode').value
            };
            if (Object.values(settingsCache).slice(0, 4).some(isNaN)) { alert('Invalid number in settings.'); return; }
            settingsOverlay.style.display = 'none'; currentScreen = 'collage';
            startCollage((60/settingsCache.bpm)*1000, settingsCache, true);
        });
        function checkOverlap(r1, r2) { const m=10; return(r1.x<r2.x+r2.width+m&&r1.x+r1.width+m>r2.x&&r1.y<r2.y+r2.height+m&&r1.y+r1.height+m>r2.y); }
        function createAndPlaceImage(s) {
            if (imageDataArray.length === 0) return;
            if (activeWrappers.length >= s.maxImages) {
                const wrapperToRemove = activeWrappers.shift();
                if (wrapperToRemove.rectData === lastImageRect) lastImageRect = null;
                if(s.animationMode === 'fade'){wrapperToRemove.style.animation='fadeOut 0.5s forwards';wrapperToRemove.addEventListener('animationend',()=>wrapperToRemove.remove(),{once:true});}else{wrapperToRemove.remove();}
            }
            if(s.orderMode==='random'){currentIndex=Math.floor(Math.random()*imageDataArray.length);}
            const imageData=imageDataArray[currentIndex]; if(s.orderMode==='sequential'){currentIndex=(currentIndex+1)%imageDataArray.length;}
            const wrapper=D.createElement('div'), img=D.createElement('img'); wrapper.className='image-wrapper'; img.className='dynamic-image'; img.src=imageData.url;
            if(s.animationMode!=='none')wrapper.classList.add(`anim-${s.animationMode}`);
            if(s.borderMode==='disabled')img.classList.add('no-border');
            let newRect,size,retries=0; const maxRetries=50,vw=window.innerWidth,vh=window.innerHeight;
            do{size=Math.random()*(s.maxSize-s.minSize)+s.minSize;const estH=size*(3/4)+(s.infoBoxMode!=='none'?100:0);newRect={x:Math.random()*(vw-size),y:Math.random()*(vh-estH),width:size,height:estH};retries++;}while(lastImageRect&&checkOverlap(newRect,lastImageRect)&&retries<maxRetries);
            wrapper.style.width=`${size}px`;wrapper.style.left=`${newRect.x}px`;wrapper.style.top=`${newRect.y}px`;wrapper.rectData=newRect;lastImageRect=newRect;
            if(s.infoBoxMode!=='none'){
                const infoBox=D.createElement('div');infoBox.className='info-box';
                infoBox.innerHTML=[`<div>ID:         ${imageData.id}</div>`,`<div>SOURCE:     ${imageData.user}</div>`,`<div>TYPE:       ${imageData.contentType}</div>`,`<div>SIZE:       ${imageData.fileSize}</div>`,`<div>CREATED_AT: ${imageData.createdAt}</div>`].join('');
                if(s.infoBoxMode==='all'){infoBox.classList.add('show-all');}else{if(lastInfoBox){lastInfoBox.classList.remove('latest-info');}infoBox.classList.add('latest-info');lastInfoBox=infoBox;}
                wrapper.appendChild(infoBox);
            }
            wrapper.insertBefore(img, wrapper.firstChild); imageContainer.appendChild(wrapper); activeWrappers.push(wrapper);
        }
        function startCollage(interval, s, isFirstRun) { if (isFirstRun) createAndPlaceImage(s); collageInterval=setInterval(()=>createAndPlaceImage(s), interval); if (isMobile) initShakeDetector(); }
        
        // --- Mobile Shake Detection ---
        function initShakeDetector() {
            let lastX, lastY, lastZ; let lastTime = new Date().getTime();
            const shakeThreshold = 20, timeThreshold = 100;
            window.addEventListener('devicemotion', (e) => {
                if (!e.acceleration.x) return;
                const currentTime = new Date().getTime();
                if ((currentTime - lastTime) > timeThreshold) {
                    const {x, y, z} = e.acceleration;
                    if(lastX !== undefined) {
                        const speed = Math.abs(x+y+z-lastX-lastY-lastZ)/(currentTime-lastTime)*10000;
                        if (speed > shakeThreshold) goBack();
                    }
                    lastTime=currentTime; lastX=x; lastY=y; lastZ=z;
                }
            });
        }
    </script>
</body>
</html>
