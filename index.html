<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Are.na Dynamic Collage Generator</title>
    <style>
        * { box-sizing: border-box; cursor: crosshair; }
        body { margin: 0; background-color: #ffffff; color: #000000; font-family: 'Courier New', Courier, monospace; overflow: hidden; }
        
        /* --- UI Screens --- */
        .ui-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 1000;
        }
        #settings-overlay {
            display: none; /* Hidden initially */
        }
        .ui-box {
            background-color: #fff;
            padding: 2rem 3rem;
            border: 1px solid #000;
            width: 500px; /* Wider box for the URL input */
            max-width: 90vw; /* Responsive for smaller screens */
        }
        .ui-box h2 {
            text-align: left; /* Align headers to the left */
        }
        .form-group { margin-bottom: 1.5rem; text-align: left; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; text-transform: uppercase; }
        .form-group input { width: 100%; padding: 0.5rem; background: none; border: 1px solid #000; font-family: inherit; font-size: 1rem; }
        
        /* Replace default blue focus outline with gray */
        .form-group input:focus, .action-button:focus {
            outline: 1px solid #888;
        }

        .action-button {
            background-color: #000; color: #fff; border: 1px solid #000;
            padding: 0.75rem 2rem; font-family: inherit; font-size: 1rem;
            text-transform: uppercase; transition: background-color 0.2s, color 0.2s;
        }
        .action-button:hover { background-color: #fff; color: #000; }
        #status-message { margin-top: 1rem; font-size: 0.9rem; min-height: 1.2em; text-align: center; }

        /* --- Collage Styles --- */
        #image-container { position: relative; width: 100vw; height: 100vh; }
        .image-wrapper { position: absolute; }
        .dynamic-image { display: block; border: 1px solid #000; width: 100%; height: auto; object-fit: cover; }
        .info-box {
            display: none; background-color: #fff; border: 1px solid #000;
            border-top: none; padding: 8px; font-size: 10px;
            line-height: 1.5; white-space: pre; width: 100%;
        }
        .info-box.latest-info { display: block; }
    </style>
</head>
<body>

    <div id="image-container"></div>

    <div id="initial-screen" class="ui-screen">
        <div class="ui-box">
            <h2>// LOAD CHANNEL</h2>
            <form id="load-form">
                <div class="form-group">
                    <label for="channel-url">ARE.NA CHANNEL URL</label>
                    <input type="text" id="channel-url" placeholder="https://www.are.na/user/slug" required>
                </div>
                <button type="submit" class="action-button">LOAD_</button>
            </form>
            <p id="status-message"></p>
        </div>
    </div>

    <div id="settings-overlay" class="ui-screen">
        <div class="ui-box">
            <h2>// CONFIGURE</h2>
            <form id="settings-form">
                <div class="form-group">
                    <label for="bpm">SPEED (BPM)</label>
                    <input type="number" id="bpm" value="100" min="1" required>
                </div>
                <div class="form-group">
                    <label for="min-size">MIN SIZE (PX)</label>
                    <input type="number" id="min-size" value="200" min="10" required>
                </div>
                <div class="form-group">
                    <label for="max-size">MAX SIZE (PX)</label>
                    <input type="number" id="max-size" value="400" min="10" required>
                </div>
                <div class="form-group">
                    <label for="max-images">MAX IMAGES ON SCREEN</label>
                    <input type="number" id="max-images" value="16" min="1" required>
                </div>
                <button type="submit" class="action-button">INITIATE_</button>
            </form>
        </div>
    </div>

    <script>
        const loadForm = document.getElementById('load-form');
        const settingsOverlay = document.getElementById('settings-overlay');
        const settingsForm = document.getElementById('settings-form');
        const initialScreen = document.getElementById('initial-screen');
        const statusMessage = document.getElementById('status-message');
        const imageContainer = document.getElementById('image-container');

        let imageDataArray = [];
        let currentIndex = 0;
        let lastInfoBox = null;
        let lastImageRect = null;
        const activeWrappers = [];

        loadForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const urlInput = document.getElementById('channel-url').value.trim();
            statusMessage.textContent = 'Parsing URL...';

            const slug = urlInput.split('/').pop();
            if (!slug) {
                statusMessage.textContent = 'Error: Invalid URL format.';
                return;
            }

            const apiUrl = `https://api.are.na/v2/channels/${slug}/contents?page=1&per=1000`;
            statusMessage.textContent = `Fetching data from ${slug}...`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}. Channel might be private or invalid.`);
                }
                const data = await response.json();
                processApiData(data);

                if (imageDataArray.length === 0) {
                     statusMessage.textContent = 'Error: No images found in this channel.';
                     return;
                }
                initialScreen.style.display = 'none';
                settingsOverlay.style.display = 'flex';
            } catch (error) {
                statusMessage.textContent = `Error: ${error.message}`;
            }
        });

        function processApiData(data) {
            imageDataArray = [];
            if (data && data.contents) {
                for (const item of data.contents) {
                    if (item.class === 'Image' && item.image?.original?.url) {
                        imageDataArray.push({
                            url: item.image.original.url,
                            id: item.id || 'N/A',
                            contentType: item.image.content_type || 'N/A',
                            fileSize: item.image.original.file_size_display || 'N/A',
                            user: item.user?.username || 'anonymous',
                            createdAt: item.created_at || 'timestamp_unavailable'
                        });
                    }
                }
            }
        }

        settingsForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const bpm = parseInt(document.getElementById('bpm').value, 10);
            const minSize = parseInt(document.getElementById('min-size').value, 10);
            const maxSize = parseInt(document.getElementById('max-size').value, 10);
            const maxImages = parseInt(document.getElementById('max-images').value, 10);
            if ([bpm, minSize, maxSize, maxImages].some(isNaN)) {
                alert('Invalid settings. Please check your values.'); return;
            }
            settingsOverlay.style.display = 'none';
            const intervalMilliseconds = (60 / bpm) * 1000;
            startCollage(intervalMilliseconds, minSize, maxSize, maxImages);
        });

        function checkOverlap(rect1, rect2) {
            const margin = 10;
            return (
                rect1.x < rect2.x + rect2.width + margin &&
                rect1.x + rect1.width + margin > rect2.x &&
                rect1.y < rect2.y + rect2.height + margin &&
                rect1.y + rect1.height + margin > rect2.y
            );
        }

        function createAndPlaceImage(minSize, maxSize, maxImages) {
            if (imageDataArray.length === 0) return;

            if (activeWrappers.length >= maxImages) {
                const wrapperToRemove = activeWrappers.shift();
                if (wrapperToRemove.rectData === lastImageRect) {
                    lastImageRect = null;
                }
                wrapperToRemove.remove();
            }

            const imageData = imageDataArray[currentIndex];
            currentIndex = (currentIndex + 1) % imageDataArray.length;

            const wrapper = document.createElement('div');
            wrapper.className = 'image-wrapper';
            const img = document.createElement('img');
            img.className = 'dynamic-image';
            img.src = imageData.url;
            const infoBox = document.createElement('div');
            infoBox.className = 'info-box';
            infoBox.innerHTML = `ID:         ${imageData.id}\nSOURCE:     ${imageData.user}\nTYPE:       ${imageData.contentType}\nSIZE:       ${imageData.fileSize}\nCREATED_AT: ${imageData.createdAt}`;
            
            if (lastInfoBox) { lastInfoBox.classList.remove('latest-info'); }
            infoBox.classList.add('latest-info');
            lastInfoBox = infoBox;

            let newRect, size;
            let retries = 0;
            const maxRetries = 50;
            const viewportWidth = window.innerWidth, viewportHeight = window.innerHeight;

            do {
                size = Math.random() * (maxSize - minSize) + minSize;
                const estimatedHeight = size * (3 / 4) + 100;
                newRect = {
                    x: Math.random() * (viewportWidth - size),
                    y: Math.random() * (viewportHeight - estimatedHeight),
                    width: size,
                    height: estimatedHeight
                };
                retries++;
            } while (lastImageRect && checkOverlap(newRect, lastImageRect) && retries < maxRetries);
            
            wrapper.style.width = `${size}px`;
            wrapper.style.left = `${newRect.x}px`;
            wrapper.style.top = `${newRect.y}px`;
            
            wrapper.rectData = newRect;
            lastImageRect = newRect;

            wrapper.appendChild(img);
            wrapper.appendChild(infoBox);
            imageContainer.appendChild(wrapper);
            activeWrappers.push(wrapper);
        }

        function startCollage(interval, minSize, maxSize, maxImages) {
            createAndPlaceImage(minSize, maxSize, maxImages);
            setInterval(() => createAndPlaceImage(minSize, maxSize, maxImages), interval);
        }
    </script>
</body>
</html>
